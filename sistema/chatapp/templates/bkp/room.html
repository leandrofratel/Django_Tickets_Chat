{% extends 'base.html' %}

{% block content %}
{% if user.is_authenticated %}

<div class="container mt-3">
    <h2 class="text-dark">{{ room_name }}</h2>
    <a href="{% url 'rooms' %}">
        <button type="button" class="btn btn-outline-dark">Voltar</button>
    </a>

    <div class="card shadow-lg mt-3">
        <!-- Área de mensagens -->
        <div class="card-body" id="chatbox" style="max-height: 600px; overflow-y: auto; background-color: #f8f9fa; border-radius: 10px;">
            {% if messages %}
                {% for message in messages %}
                    <div class="d-flex {% if message.user == request.user %} justify-content-end {% else %} justify-content-start {% endif %} mb-2">
                        <div class="p-2 rounded text-white {% if message.user == request.user %} bg-primary {% else %} bg-secondary {% endif %}" style="max-width: 70%;">
                            <strong>{{ message.user.username }}</strong><br>
                            {% if message.content %}
                                {{ message.content }}
                            {% endif %}
                            {% if message.image %}
                                <img src="{{ message.image }}" class="img-fluid rounded" style="max-width: 300px;">
                            {% endif %}
                            <small class="text-muted"> - {{ message.created_on|date:"d/m H:i" }}</small>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-muted text-center">Nenhuma mensagem ainda.</p>
            {% endif %}
        </div>

        <!-- Formulário de envio de mensagens -->
        <div class="card-footer bg-white">
            <form class="d-flex">
                <input class="form-control me-2" placeholder="Digite sua mensagem..." id="my_input" type="text" required>
                <button type="button" id="submit_button" class="btn btn-primary">
                    <i class="bi bi-send"></i>
                </button>
                <!-- Botão de anexar imagem -->
                <button type="button" id="attachment_button" class="btn btn-primary ms-2">
                    <i class="bi bi-paperclip"></i>
                </button>
                <!-- Input de arquivo para imagens -->
                <input type="file" id="image_input" style="display: none;" accept="image/*">
            </form>
        </div>
    </div>
</div>

{{ slug|json_script:"room_slug" }}

<script>
document.addEventListener("DOMContentLoaded", function () {
    const chatbox = document.querySelector("#chatbox");
    const inputField = document.querySelector("#my_input");
    const sendButton = document.querySelector("#submit_button");
    const attachmentButton = document.querySelector("#attachment_button");
    const imageInput = document.querySelector("#image_input");
    const roomName = JSON.parse(document.getElementById('room_slug').textContent);
    const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/" + roomName + "/");

    // Função para rolar para o fundo do chat
    function scrollToBottom() {
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Inicializa a rolagem para a parte inferior
    scrollToBottom();

    // Quando o WebSocket se conectar
    chatSocket.onopen = function () {
        console.log("Conexão estabelecida!");
    };

    // Quando o WebSocket se desconectar
    chatSocket.onclose = function () {
        console.log("Conexão fechada inesperadamente!");
    };

    // Função para enviar uma mensagem de texto
    function sendMessage() {
        const messageInput = inputField.value.trim();

        if (messageInput.length > 0) {
            chatSocket.send(JSON.stringify({
                message: messageInput,
                username: "{{ request.user.username }}",
                room_name: "{{ room_name }}"
            }));
            inputField.value = "";
        }
    }

    // Função para enviar uma imagem
    function sendImage(imageFile) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const imageData = e.target.result;

            // Enviar a imagem via WebSocket
            chatSocket.send(JSON.stringify({
                image: imageData,
                username: "{{ request.user.username }}",
                room_name: "{{ room_name }}"
            }));
        };
        
        // Ler a imagem como Data URL (Base64)
        reader.readAsDataURL(imageFile);
    }

    // Enviar mensagem ao pressionar Enter
    inputField.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    });

    // Enviar mensagem ao clicar no botão de envio
    sendButton.addEventListener("click", sendMessage);

    // Quando um arquivo for selecionado, envia a imagem
    attachmentButton.addEventListener("click", function () {
        imageInput.click();
    });

    // Quando a imagem for selecionada, envia a imagem
    imageInput.addEventListener("change", function () {
        const file = imageInput.files[0];
        if (file) {
            sendImage(file);
            imageInput.value = ""; // Limpa o input de arquivo
        }
    });

    // Quando uma nova mensagem (ou imagem) for recebida
    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const div = document.createElement("div");

        // Estilizar a mensagem
        div.classList.add("d-flex", "mb-2");
        if (data.username === "{{ request.user.username }}") {
            div.classList.add("justify-content-end");
        } else {
            div.classList.add("justify-content-start");
        }

        const messageDiv = document.createElement("div");
        messageDiv.classList.add("p-2", "rounded", "text-white");
        if (data.username === "{{ request.user.username }}") {
            messageDiv.classList.add("bg-primary");
        } else {
            messageDiv.classList.add("bg-secondary");
        }

        // Se for uma imagem, exiba a imagem no chat
        if (data.image) {
            const img = document.createElement("img");
            img.src = data.image;
            img.classList.add("img-fluid", "rounded");
            img.style.maxWidth = "300px"; // Limitar o tamanho da imagem
            messageDiv.appendChild(img);
        } else {
            // Se for uma mensagem de texto, exiba o texto
            messageDiv.innerHTML = `<strong>${data.username}</strong><br>${data.message}`;
        }

        // Adicionar a hora da mensagem
        const time = document.createElement("small");
        time.classList.add("text-muted");
        time.innerText = ` - ${new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}`;
        messageDiv.appendChild(time);

        div.appendChild(messageDiv);
        chatbox.appendChild(div);
        scrollToBottom();
    };
});
</script>

{% else %}
<!-- Mensagem para usuários não logados -->
<div class="container mt-3">
    <div class="alert alert-info text-center">
        <h5 class="mb-0">Você não está logado</h5>
        <a href="{% url 'login' %}" class="btn btn-outline-dark mt-2">Log In</a>
    </div>
</div>
{% endif %}

<br/>
{% endblock %}