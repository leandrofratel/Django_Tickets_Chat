{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
{% if user.is_authenticated %}

  <div class="container">
    <div class="row d-flex justify-content-center">
        <div class="col-12">
            <div class="alert alert-info d-flex justify-content-between" role="alert">
              <h5>{{room_name}}</h5>
              <a href="/accounts/logout/">
                <button type="button" class="btn btn-light">Click to Log Out</button>
              </a>
            </div>
            <form>
                <div class="form-group">
                  {% if messages %}
                  <div class="jumbotron" id="chatbox" style="padding: 4px 2px; max-height: 300px; overflow-y: scroll;">
                      {% for message in messages %}
                        <div class="chat-message {% if message.user == request.user %}text-right{% else %}text-left{% endif %}">
                          <b>{{ message.user.username }}</b> : {{ message.content }}<br>
                        </div>
                      {% endfor %}
                  </div>
                  {% else %}
                  <div class="jumbotron" id="chatbox" style="padding: 4px 2px;"></div>
                  {% endif %}
                </div>
                <br/>
                <div class="form-group" style="width: 100%;">
                    <input class="form-control" placeholder="Enter text here" id="my_input" type="text" required></br>
                </div>
                <br/>
                <input class="btn btn-primary btn-lg btn-block" id="submit_button" type="button" value="Send">
            </form>
        </div>
    </div>
</div>

{{ slug|json_script:"room_slug" }}

<script>
document.addEventListener("DOMContentLoaded", function () {
    const chatbox = document.querySelector("#chatbox");
    const inputField = document.querySelector("#my_input");
    const sendButton = document.querySelector("#submit_button");
    const roomName = JSON.parse(document.getElementById('room_slug').textContent);
    const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/" + roomName + "/");

    function scrollToBottom() {
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Scroll para baixo ao carregar a página
    scrollToBottom();

    chatSocket.onopen = function () {
        console.log("The connection was setup successfully!");
    };

    chatSocket.onclose = function () {
        console.log("Something unexpected happened!");
    };

    function sendMessage() {
        const messageInput = inputField.value.trim();

        if (messageInput.length > 0) {
            chatSocket.send(JSON.stringify({
                message: messageInput,
                username: "{{request.user.username}}",
                room_name: "{{room_name}}"
            }));
            inputField.value = "";  // Limpa o campo de entrada
        }
    }

    // Evento para enviar mensagem ao pressionar Enter
    inputField.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    });

    // Evento para enviar mensagem ao clicar no botão
    sendButton.addEventListener("click", sendMessage);

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const div = document.createElement("div");
        div.innerHTML = "<b>" + data.username + "</b> : " + data.message;

        if (data.username === "{{ request.user.username }}") {
            div.classList.add("chat-message", "text-right");
        } else {
            div.classList.add("chat-message", "text-left");
        }

        chatbox.appendChild(div);
        scrollToBottom();
    };
});
</script>

{% else %}
<div class="container">
    <div class="alert alert-info d-flex justify-content-between" role="alert">
        <h5>You are not logged in</h5>
        <a href="{% url 'login' %}">
          <button type="button" class="btn btn-light">Log In</button>
        </a>
    </div>
</div>  
{% endif %}

<br/>

{% endblock %}
